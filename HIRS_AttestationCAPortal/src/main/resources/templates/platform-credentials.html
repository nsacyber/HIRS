<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout}">

<head>
  <section layout:fragment="script">
    <script th:inline="javascript">
      $(document).ready(function () {
        const viewName = /*[[${ page.viewName }]]*/ '';
        const url = viewName + "/list";
        let columns = [
          {
            name: "deviceName",
            data: "deviceName",
            columnControl: ["searchDropdown"],
            orderable: true,
            searchable: true,
            render: function (data, type, full, meta) {
              // if there is a device, display its name, otherwise
              return full.deviceName;
            },
          },
          {
            name: "issuer",
            data: "issuer",
            columnControl: ["searchDropdown"],
            orderable: true,
            searchable: true,
          },
          {
            name: "credentialType",
            data: "credentialType",
            columnControl: ["searchDropdown"],
            orderable: true,
            searchable: true,
            render: function (data, type, full, meta) {
              if (full.platformChainType !== "") {
                return full.platformChainType;
              } else {
                return full.credentialType;
              }
            },
          },
          {
            name: "manufacturer",
            data: "manufacturer",
            columnControl: ["searchDropdown"],
            orderable: true,
            searchable: true,
          },
          { name: "model", data: "model", orderable: true, searchable: true, columnControl: ["searchDropdown"], },
          { name: "version", data: "version", orderable: true, searchable: true, columnControl: ["searchDropdown"], },
          { name: "platformSerial", data: "platformSerial", orderable: true, searchable: true, columnControl: ["searchDropdown"], },
          {
            name: "beginValidity",
            data: "beginValidity",
            columnControl: ["searchDropdown"],
            orderable: true,
            searchable: false,
            render: function (data, type, full, meta) {
              return formatCertificateDate(full.beginValidity);
            },
          },
          {
            name: "endValidity",
            data: "endValidity",
            columnControl: ["searchDropdown"],
            orderable: true,
            searchable: false,
            render: function (data, type, full, meta) {
              return formatCertificateDate(full.endValidity);
            },
          },
          {
            data: "id",
            orderable: false,
            searchable: false,
            render: function (data, type, full, meta) {
              //Display endorsement credential
              if (full.endorsementCredential === null) return "";
              let html = "";

              let id = full.endorsementCredential.id;
              html =
                certificateDetailsLink("endorsement", id, false) + "&nbsp;";

              return html;
            },
          },
          {
            data: "id",
            orderable: false,
            searchable: false,
            render: function (data, type, full, meta) {
              // Set up a delete icon with link to handleDeleteRequest().
              // sets up a hidden input field containing the ID which is
              // used as a parameter to the REST POST call to delete
              let html = "";
              html += certificateDetailsLink("platform", full.id, true);
              html += certificateDownloadLink(viewName, full.id);
              html += certificateDeleteLink(viewName, full.id);

              return html;
            },
          },
        ];

        // Set data tables
        setDataTables("#platformTable", url, columns);
      });
    </script>
  </section>
</head>

<body>

  <h1 layout:fragment="pageHeaderTitle">Platform Certificates</h1>

  <div class="content" layout:fragment="content">
    <!-- text and icon resource variables -->
    <div class="aca-input-box-header">
      <form method="POST"
        th:action="@{/HIRS_AttestationCAPortal/portal/certificate-request/platform-credentials/upload}"
        enctype="multipart/form-data">
        Platform Credentials
        <th:block th:replace="fragments/file-chooser
                :: fileChooser('platformCredentialEditor',
                'Import Platform Credentials', ~{this :: bodyContent})">
          <th:block th:fragment="bodyContent">
            <input id="importFile" type="file" name="file" multiple="multiple" />
          </th:block>
        </th:block>
        <a th:href="@{/HIRS_AttestationCAPortal/portal/certificate-request/platform-credentials/bulk-download}">
          <img th:src="@{/icons/ic_file_download_black_24dp.png}" title="Download All Platform Certificates">
        </a>
      </form>
    </div>

    <br />

    <div class="aca-data-table">
      <table id="platformTable" class="table table-bordered table-striped table-hover">
        <thead>
          <tr>
            <th>Device</th>
            <th>Issuer</th>
            <th>Type</th>
            <th>Manufacturer</th>
            <th>Model</th>
            <th>Version</th>
            <th>Board SN</th>
            <th>Valid (begin)</th>
            <th>Valid (end)</th>
            <th>Endorsement</th>
            <th>Options</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>

</body>

</html>