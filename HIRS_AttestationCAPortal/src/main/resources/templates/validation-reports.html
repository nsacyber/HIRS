<!DOCTYPE html>
<html lang="en" layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:th="http://www.thymeleaf.org">

<head>
  <section layout:fragment="script">
    <script th:inline="javascript">
      const passIcon = /*[[@{/icons/svg/check-circle-green-fill-24dp.svg}]]*/ '';
      const failIcon = /*[[@{/icons/svg/exclamation-red-circle-fill-24dp.svg}]]*/ '';
      const errorIcon = /*[[@{/icons/svg/exclamation-triangle-fill-warning-24dp.svg}]]*/ '';
      const unknownIcon = /*[[@{/icons/svg/question-circle-red-fill-24dp.svg}]]*/ '';

      const passText = "Validation Passed";
      const failText = "Validation Failed";
      const errorText = "Validation Error";
      const unknownText = "Unknown Validation Status";

      $(document).ready(function () {
        const viewName = /*[[${ page.viewName }]]*/ '';
        const url = viewName + "/list";
        let columns = [
          {
            data: null,
            orderable: false,
            searchable: false,
            render: DataTable.render.select()
          },
          {
            name: "overallValidationResult",
            data: "overallValidationResult",
            searchable: false,
            orderable: false,
            render: function (data, type, full, meta) {
              let html = "";
              const unknownStatus = `<img class="icon" src="${unknownIcon}" title="${unknownText}" />`;

              const result = full.overallValidationResult;

              const overallMessage = full.message;

              // create status icon
              if (result) {
                switch (result) {
                  case "PASS":
                    html += `<img src="${passIcon}" title="${passText}" />`;
                    break;
                  case "FAIL":
                    html +=
                      `<img src="${failIcon}" title="${overallMessage}" />`;
                    break;
                  case "ERROR":
                    html +=
                      `<img src="${errorIcon}" title="${overallMessage}" />`;
                    break;
                  default:
                    html += unknownStatus;
                    break;
                }
              } else {
                html += unknownStatus;
              }

              return html;
            },
          },
          {
            data: "createTime",
            name: "createTime",
            type: "date",
            searchable: true,
            orderable: true,
            columnControl: ["searchDropdown"],
            render: function (data, type, full, meta) {
              return formatCertificateDate(data);
            },
          },
          {
            // TODO render a link to a device details page,
            // passing the device.id
            name: "device.name",
            data: "device.name",
            searchable: true,
            orderable: true,
            columnControl: ["searchDropdown"],
          },
          {
            data: "id",
            searchable: false,
            orderable: false,
            render: function (data, type, full, meta) {
              return getValidationDisplayHtml(full, "ENDORSEMENT_CREDENTIAL");
            },
          },
          {
            data: "id",
            searchable: false,
            orderable: false,
            render: function (data, type, full, meta) {
              return getValidationDisplayHtml(full, "PLATFORM_CREDENTIAL");
            },
          },
          {
            data: "id",
            searchable: false,
            orderable: false,
            render: function (data, type, full, meta) {
              return getValidationDisplayHtml(full, "FIRMWARE");
            },
          },
        ];

        //Set data tables
        let dataTable = setDataTables(viewName, "#reportTable", url, columns);

        dataTable.order([1, "desc"]).draw(); //order by createTime

        $("#download").submit(function (e) {
          let tableLength = $("#reportTable").rows;
          let createTimes = "";
          let deviceNames = "";
          $("#reportTable tr")
            .not("thead tr")
            .each(function () {
              createTimes += $(this).find("td").eq(1).html() + ";";
              deviceNames += $(this).find("td").eq(2).html() + ",";
            });
          createTimes = createTimes.substring(0, createTimes.length - 1);
          deviceNames = deviceNames.substring(0, deviceNames.length - 1);
          let params = [
            {
              name: "createTimes",
              value: createTimes,
            },
            {
              name: "deviceNames",
              value: deviceNames,
            },
          ];
          $(this).append(
            $.map(params, function (param) {
              return $("<input>", {
                type: "hidden",
                name: param.name,
                value: param.value,
              });
            })
          );
        });

        $(".btn-primary").click(function () {
          $("#validationReportsDownload").modal("hide");
        });
      });

    </script>
  </section>
</head>

<body>
  <h1 layout:fragment="pageHeaderTitle">Validation Reports</h1>

  <div layout:fragment="content">

    <form id="download" method="POST" th:action="@{/HIRS_AttestationCAPortal/portal/validation-reports/download}">
      Download Validation Reports
      <th:block th:replace="~{fragments/download-info
                :: downloadInfo(id='validationReportsDownload',
                label='Download Validation Reports',
                bodyContent=~{this :: bodyContent})}">
        <th:block th:fragment="bodyContent">
          <label>Company<input id="company" name="company" pattern="^\w*$" title="Letters, numbers, and spaces only"
              type="text" /></label>
          <label>Contract #<input id="contract" name="contract" pattern="^\w*$"
              title="Letters, numbers, and spaces only" type="text" /></label>
          <br>
          <label>Date range start<input id="dateStart" name="dateStart" type="date" /></label>
          <label>Date range end<input id="dateEnd" name="dateEnd" type="date" /></label>
        </th:block>
      </th:block>
    </form>

    <div class="aca-data-table">
      <table class="table table-bordered table-striped table-hover" id="reportTable">
        <thead>
          <tr>
            <th rowspan="2"></th>
            <th rowspan="2">Result</th>
            <th rowspan="2">Timestamp</th>
            <th rowspan="2">Device</th>
            <th class="text-center" colspan="3">Credential Validations</th>
          </tr>
          <tr>
            <th style="text-align: center">Endorsement</th>
            <th style="text-align: center">Platform</th>
            <th style="text-align: center">Firmware</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</body>

</html>