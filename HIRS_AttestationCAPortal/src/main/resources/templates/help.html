<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout}">

<head>
  <section layout:fragment="script">
    <script th:inline="javascript">
      $(document).ready(function () {
        const viewName = /*[[${ page.viewName }]]*/ '';
        const url = viewName + "/list-main-logger";

        const levels = ["ERROR", "WARN", "INFO", "DEBUG"];
        const mainLoggerName = "hirs.attestationca";
        const mainLoggerPath = "var/log/hirs/HIRS_AttestationCA_Portal.log";

        // Define log levels to button color mapping
        const logLevelColors = {
          ERROR: "btn-danger", // Red for ERROR
          WARN: "btn-warning", // Yellow for WARN
          INFO: "btn-info", // Light Blue for INFO
          DEBUG: "btn-primary", // Blue for DEBUG
        };

        // Define log level to text color class mapping
        const logLevelTextColors = {
          ERROR: "text-danger", // Red for ERROR
          WARN: "text-warning", // Yellow for WARN
          INFO: "text-info",    // Light Blue for INFO
          DEBUG: "text-primary", // Blue for DEBUG
        };

        // When the "logLevelChangeConfirmationModal" modal is about to be shown:
        // - Retrieve the new log level and logger name from the button that triggered the modal (via data-loggerName and data-newLogLevel attributes)
        // - Set the value of the hidden input field 'logLevel' to the retrieved logger level
        // - Set the value of the hidden input field 'loggerName' to the retrieved logger name
        // - Set the value of the hidden input field 'currentLogLevel' to the retrieved current log level
        $('#logLevelChangeConfirmationModal').on('show.bs.modal', function (event) {
          const changeLogLevelLinkButton = $(event.relatedTarget);  // Link that triggered the modal
          const loggerName = changeLogLevelLinkButton.data('loggername');  // Extract the logger name from the data-loggerName attribute
          const newLogLevel = changeLogLevelLinkButton.data('newloglevel');  // Extract the logger level from the data-newLogLevel attribute
          const currentLogLevel = changeLogLevelLinkButton.data('currentloglevel'); // Extract the actual log level from the data-currentLogLevel attribute

          // Set the value of the hidden input to the ID
          $(this).find('#loggerName').val(loggerName);
          $(this).find('#logLevel').val(newLogLevel);
          $(this).find('#currentLogLevel').val(currentLogLevel);

          // Update the text in the modal body
          $('#currentLogLevelText').text(currentLogLevel);
          $('#newLogLevelText').text(newLogLevel);

          // Apply the text color class to the new log level and the current log level text
          const newLogLevelTextColorClass = logLevelTextColors[newLogLevel] || 'text-muted'; // Default to 'text-muted' if no match
          const currentLogLevelTextColorClass = logLevelTextColors[currentLogLevel] || 'text-muted'; // Default to 'text-muted' if no match
          $('#currentLogLevelText').removeClass().addClass(currentLogLevelTextColorClass);  // Apply text color class to current log level text
          $('#newLogLevelText').removeClass().addClass(newLogLevelTextColorClass);  // Apply text color class to new log level text
        });

        // Setup Help Page's Logger table columns
        let columns = [
          {
            name: "loggerName",
            data: "loggerName",
            render: function (data, type, row) {
              // if the row's logger name is the same as the main logger name
              if (row.loggerName.toLowerCase() === mainLoggerName.toLowerCase()) {
                // display the main logger's path
                return mainLoggerPath;
              }
              // otherwise just return the row's logger name as is
              return row.loggerName;
            },
          },
          {
            name: "logLevel",
            data: "logLevel",
          },
          {
            name: "changeLogLevel",
            data: "logLevel",
            render: function (data, type, row) {
              const currentLogLevel = data;

              // Start the btn-group div to wrap all the buttons
              let buttonsHtml = '<div class="btn-group" role="group">';

              // Loop through the log levels and generate buttons
              levels.forEach(function (eachLogLevel) {
                let logLevelColor = logLevelColors[eachLogLevel] || "btn-secondary"; // Default to gray if color not found

                // Append button HTML for the current log level
                // Use the generateLogLevelChangeButton function to generate the button with color
                buttonsHtml += generateLogLevelChangeButton(row.loggerName, currentLogLevel, eachLogLevel, logLevelColor);
              });

              // Close the btn-group div
              buttonsHtml += "</div>";

              return buttonsHtml;
            }
          },
        ];

        const customConfiguration = {
          colReorder: false,
          select: false,
          searching: false,
          ordering: false,
          paging: false,
          info: false,
          layout: {
            topStart: {
              buttons: []  // No buttons will be shown
            }
          }
        }

        //Set data tables
        let dataTable = setDataTables(viewName, "#loggersTable", url, columns, customConfiguration);
      });
    </script>
  </section>
</head>

<body>

  <h1 layout:fragment="pageHeaderTitle">Help </h1>

  <div layout:fragment="content">
    <div>
      <h2>Documentation</h2>
      <p>
        For more documentation on the project, you may visit the wiki section of
        our
        <a th:href="@{https://github.com/nsacyber/HIRS/wiki}"> code repository. </a>
      </p>
    </div>
    <hr />

    <div class="aca-data-table">
      <h2>Main HIRS Logger Management</h2>
      <div class="download-header">
        <h3>Download All HIRS Attestation Log Files</h3>
        <a th:href="@{/HIRS_AttestationCAPortal/portal/help/hirs-logs-download}">
          <img th:src="@{/icons/ic_file_download_black_24dp.png}" alt="Download HIRS Logs" />
        </a>
      </div>
      <table id="loggersTable" class="table table-bordered table-striped table-hover">
        <thead>
          <tr>
            <th>Logger Name</th>
            <th>Current Log Level</th>
            <th>Change Log Level</th>
          </tr>
        </thead>
      </table>
    </div>

    <!-- This modal will be triggered when the user selects one of the four log level buttons on the log level change table -->
    <form method="POST" th:action="@{/HIRS_AttestationCAPortal/portal/help/setLogLevel}">
      <div
        th:replace="~{fragments/modal :: modal(id='logLevelChangeConfirmationModal', label='Confirm Log Level Change', 
                bodyContent=~{this::#logLvlChangeConfirmationBody}, customFooterButtons=~{this::#logLvlChangeConfirmationFooterButtons})}">

        <!-- Modal Body Content -->
        <div id="logLvlChangeConfirmationBody">
          <p class="text-center fs-5"> <strong>Are you sure you want to change the log level from <span
                id="currentLogLevelText"></span> to <span id="newLogLevelText"></span>?</strong>
          </p>
        </div>

        <!-- Define custom footer buttons here -->
        <div id="logLvlChangeConfirmationFooterButtons">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <!-- The logger name, current log level and log level are stored in the hidden fields -->
          <input type="hidden" name="currentLogLevel" id="currentLogLevel" value="">
          <input type="hidden" name="loggerName" id="loggerName" value="">
          <input type="hidden" name="logLevel" id="logLevel" value="">
          <button type="submit" class="btn btn-primary">Change Log Level</button>
        </div>
      </div>
    </form>

  </div>
</body>

</html>